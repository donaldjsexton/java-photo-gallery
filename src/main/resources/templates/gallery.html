<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Heroui Gallery Studio</title>
        <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
        <meta
            name="_csrf_header"
            th:if="${_csrf != null}"
            th:content="${_csrf.headerName}"
        />
        <link rel="stylesheet" th:href="@{/css/style.css}" />
    </head>
    <body class="page">
        <div class="bg-mesh"></div>
        <div class="shell">
            <div class="card" th:if="${message != null}" style="margin-bottom: 16px;">
                <div class="muted small" th:text="${message}"></div>
            </div>
            <section class="flow" th:if="${flowMode}">
                <div class="flow-head">
                    <div>
                        <p class="eyebrow">Getting started</p>
                        <h2>Create a new album</h2>
                        <p class="muted small">
                            We’ll guide you through a quick setup.
                        </p>
                    </div>
                    <span class="pill ghost">Quick setup</span>
                </div>
                <div class="flow-steps">
                    <div
                        class="flow-card"
                        th:classappend="${flowStep > 1} ? ' done' : (${flowStep == 1} ? ' active' : ' pending')"
                    >
                        <span class="dot"></span>
                        <div class="flow-meta">
                            <p class="eyebrow">Step 1</p>
                            <h3>Choose a category</h3>
                            <p class="muted small">
                                Pick where this album should live.
                            </p>
                        </div>
                        <span
                            class="pill ghost"
                            th:text="${currentCategory != null ? currentCategory.name : 'Choose one'}"
                        ></span>
                    </div>
                    <div
                        class="flow-card"
                        th:classappend="${flowStep > 2} ? ' done' : (${flowStep == 2} ? ' active' : ' pending')"
                    >
                        <span class="dot"></span>
                        <div class="flow-meta">
                            <p class="eyebrow">Step 2</p>
                            <h3>Name your album</h3>
                            <p class="muted small">
                                Use your client or event name.
                            </p>
                        </div>
                        <span
                            class="pill ghost"
                            th:text="${currentAlbum != null ? currentAlbum.name : 'Not named yet'}"
                        ></span>
                    </div>
                    <div
                        class="flow-card"
                        th:classappend="${flowStep > 3} ? ' done' : (${flowStep == 3} ? ' active' : ' pending')"
                    >
                        <span class="dot"></span>
                        <div class="flow-meta">
                            <p class="eyebrow">Step 3</p>
                            <h3>Create your gallery</h3>
                            <p class="muted small">
                                Add the first gallery inside this album.
                            </p>
                        </div>
                        <span
                            class="pill ghost"
                            th:text="${currentGallery != null ? currentGallery.title : 'Almost there'}"
                        ></span>
                    </div>
                    <div
                        class="flow-card"
                        th:classappend="${flowStep == 4} ? ' active' : ' pending'"
                    >
                        <span class="dot"></span>
                        <div class="flow-meta">
                            <p class="eyebrow">Step 4</p>
                            <h3>Add photos</h3>
                            <p
                                class="muted small"
                                th:text="${currentGallery != null ? 'Uploading to ' + currentGallery.title : 'Waiting for a gallery'}"
                            ></p>
                        </div>
                        <span
                            class="pill ghost"
                            th:text="${currentGallery != null ? 'Gallery #' + currentGallery.id : 'Ready when you are'}"
                        ></span>
                    </div>
                </div>
            </section>

            <main class="workbench" th:if="${flowMode}">
                <section class="column main">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <p class="eyebrow">Wizard</p>
                                <h2 th:text="${'Step ' + flowStep}"></h2>
                            </div>
                        </div>

                        <div th:switch="${flowStep}">
                            <div th:case="1">
                                <p class="muted small">
                                    Choose a category, or add a new one.
                                </p>
                                <form
                                    class="form stacked"
                                    th:action="@{/flow/album}"
                                    method="get"
                                >
                                    <input type="hidden" name="step" value="2" />
                                    <label>
                                        <span>Category</span>
                                        <select name="categoryId" required>
                                            <option value="" selected>
                                                Choose…
                                            </option>
                                            <option
                                                th:each="c : ${categories}"
                                                th:value="${c.id}"
                                                th:text="${c.name}"
                                            ></option>
                                        </select>
                                    </label>
                                    <div class="actions">
                                        <button type="submit">Next</button>
                                    </div>
                                </form>

                                <hr class="divider" />

                                <form
                                    class="form stacked"
                                    th:action="@{/categories}"
                                    method="post"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input
                                        type="hidden"
                                        name="redirectTo"
                                        value="/flow/album?step=2&categoryId={categoryId}"
                                    />
                                    <label>
                                        <span>Add a new category</span>
                                        <input
                                            type="text"
                                            name="name"
                                            placeholder="e.g., Weddings"
                                            required
                                        />
                                    </label>
                                    <label>
                                        <span>Description</span>
                                        <input
                                            type="text"
                                            name="description"
                                            placeholder="Optional"
                                        />
                                    </label>
                                    <div class="actions">
                                        <button type="submit">
                                            Save category &amp; continue
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div th:case="2">
                                <p class="muted small">
                                    Tell us about this album.
                                </p>
                                <div
                                    class="chip ghost"
                                    th:if="${currentCategory != null}"
                                    th:text="${'Category: ' + currentCategory.name}"
                                ></div>
                                <form
                                    class="form stacked"
                                    th:action="@{/albums}"
                                    method="post"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input
                                        type="hidden"
                                        name="categoryId"
                                        th:value="${currentCategory != null ? currentCategory.id : ''}"
                                    />
                                    <input
                                        type="hidden"
                                        name="redirectTo"
                                        value="/flow/album?step=3&albumId={albumId}"
                                    />
                                    <label>
                                        <span>Album name</span>
                                        <input
                                            type="text"
                                            name="name"
                                            placeholder="Client or event name"
                                            required
                                        />
                                    </label>
                                    <label>
                                        <span>Description</span>
                                        <input
                                            type="text"
                                            name="description"
                                            placeholder="A short note (optional)"
                                        />
                                    </label>
                                    <div class="actions">
                                        <button type="submit">
                                            Save album
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div th:case="3">
                                <p class="muted small">
                                    Add your first gallery.
                                </p>
                                <div
                                    class="chip ghost"
                                    th:if="${currentAlbum != null}"
                                    th:text="${'Album: ' + currentAlbum.name}"
                                ></div>
                                <form
                                    class="form stacked"
                                    th:action="@{/galleries}"
                                    method="post"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input
                                        type="hidden"
                                        name="albumId"
                                        th:value="${currentAlbum != null ? currentAlbum.id : ''}"
                                    />
                                    <input
                                        type="hidden"
                                        name="redirectTo"
                                        value="/flow/album?step=4&galleryId={galleryId}"
                                    />
                                    <label>
                                        <span>Gallery name</span>
                                        <input
                                            type="text"
                                            name="title"
                                            placeholder="Gallery name"
                                            required
                                        />
                                    </label>
                                    <label>
                                        <span>Description</span>
                                        <input
                                            type="text"
                                            name="description"
                                            placeholder="Optional"
                                        />
                                    </label>
                                    <div class="actions">
                                        <button type="submit">
                                            Save gallery
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div th:case="4">
                                <p class="muted small">
                                    Add photos now, or you can do it later.
                                </p>
                                <div
                                    class="chip ghost"
                                    th:if="${currentGallery != null}"
                                    th:text="${'Gallery: ' + currentGallery.title}"
                                ></div>
                                <form
                                    class="form stacked"
                                    id="bulkUploadForm"
                                    th:action="@{/upload}"
                                    method="post"
                                    enctype="multipart/form-data"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input
                                        type="hidden"
                                        name="galleryId"
                                        th:value="${currentGallery != null ? currentGallery.id : ''}"
                                    />
                                    <input
                                        type="hidden"
                                        name="redirectTo"
                                        value="/{gallerySlug}"
                                    />
                                    <label>
                                        <span>Photos</span>
                                        <input
                                            type="file"
                                            name="files"
                                            id="fileInput"
                                            multiple
                                            required
                                        />
                                    </label>
                                    <label>
                                        <span>On duplicates</span>
                                        <select name="duplicateMode" id="duplicateMode">
                                            <option value="cancel" selected>
                                                Stop (default)
                                            </option>
                                            <option value="skip">Skip</option>
                                            <option value="overwrite">Overwrite</option>
                                        </select>
                                    </label>
                                    <div class="muted small" id="uploadStatus"></div>
                                    <div class="actions">
                                        <button type="submit">
                                            Upload photos
                                        </button>
                                        <a
                                            class="ghost-btn"
                                            th:if="${currentGallery != null}"
                                            th:href="${currentGallery.slug != null ? '/' + currentGallery.slug : '/gallery/' + currentGallery.id}"
                                        >
                                            Do this later
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </article>
                </section>
            </main>

            <main class="gallery-page" th:if="${!flowMode}">
                <article class="card">
                    <div class="card-head align-end">
                        <div class="stack">
                            <p class="eyebrow">Gallery</p>
                            <h2
                                th:text="${currentGallery != null ? currentGallery.title : 'Select a gallery from your dashboard'}"
                            ></h2>
                            <div
                                class="muted small"
                                th:if="${currentGallery != null}"
                                th:text="${currentAlbum != null ? currentAlbum.name : 'No album'}"
                            ></div>
                        </div>

                        <div class="stack" style="align-items: flex-end;">
                            <a class="pill ghost" th:href="@{/dashboard}">
                                Back to dashboard
                            </a>
                            <div class="sorter" th:if="${currentGallery != null}">
                                <label class="muted small">Sort</label>
                                <select
                                    onchange="
                                        const baseUrl =
                                            /*[[${currentGallery != null and currentGallery.slug != null ? '/' + currentGallery.slug + '?sort=' : '/gallery/' + currentGallery.id + '?sort='}]]*/ '';
                                        if (baseUrl) {
                                            window.location.href =
                                                baseUrl + this.value;
                                        }
                                    "
                                >
                                    <option
                                        value="uploadDate"
                                        th:selected="${currentSort == 'uploadDate'}"
                                    >
                                        Latest uploaded
                                    </option>
                                    <option
                                        value="dateTaken"
                                        th:selected="${currentSort == 'dateTaken'}"
                                    >
                                        Date taken (newest)
                                    </option>
                                    <option
                                        value="dateTakenAsc"
                                        th:selected="${currentSort == 'dateTakenAsc'}"
                                    >
                                        Date taken (oldest)
                                    </option>
                                    <option
                                        value="camera"
                                        th:selected="${currentSort == 'camera'}"
                                    >
                                        Camera model
                                    </option>
                                    <option
                                        value="withCamera"
                                        th:selected="${currentSort == 'withCamera'}"
                                    >
                                        Has camera info
                                    </option>
                                    <option
                                        value="withDateTaken"
                                        th:selected="${currentSort == 'withDateTaken'}"
                                    >
                                        Has date taken
                                    </option>
                                </select>
                            </div>

                            <details class="manage" th:if="${currentGallery != null}">
                                <summary class="pill ghost">
                                    Manage gallery
                                </summary>

                                <form
                                    class="form stacked"
                                    th:action="@{/galleries/{id}(id=${currentGallery.id})}"
                                    method="post"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input type="hidden" name="_method" value="PUT" />
                                    <input
                                        type="hidden"
                                        name="redirectTo"
                                        value="/{gallerySlug}"
                                    />
                                    <label>
                                        <span>Title</span>
                                        <input
                                            type="text"
                                            name="title"
                                            th:value="${currentGallery.title}"
                                            required
                                        />
                                    </label>
                                    <label>
                                        <span>Description</span>
                                        <input
                                            type="text"
                                            name="description"
                                            th:value="${currentGallery.description}"
                                            placeholder="Optional"
                                        />
                                    </label>
                                    <label>
                                        <span>Visibility</span>
                                        <select name="visibility">
                                            <option
                                                value="private"
                                                th:selected="${currentGallery.visibility == 'private'}"
                                            >
                                                Private
                                            </option>
                                            <option
                                                value="public"
                                                th:selected="${currentGallery.visibility == 'public'}"
                                            >
                                                Public
                                            </option>
                                        </select>
                                    </label>
                                    <div class="actions">
                                        <button type="submit">
                                            Save changes
                                        </button>
                                    </div>
                                </form>

                                <form
                                    th:action="@{/galleries/{id}(id=${currentGallery.id})}"
                                    method="post"
                                    onsubmit="return confirm('Delete this gallery? Any sub-galleries will be moved to the root. Photos not used in other galleries will be deleted.');"
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input type="hidden" name="_method" value="DELETE" />
                                    <input type="hidden" name="redirectTo" value="/dashboard" />
                                    <div class="actions">
                                        <button type="submit" class="danger">
                                            Delete gallery
                                        </button>
                                    </div>
                                </form>
                            </details>
                        </div>
                    </div>
                </article>

                <div class="masonry" id="masonryGrid" th:if="${currentGallery != null}">
                    <div
                        class="tile"
                        th:each="photo : ${photos}"
                        th:attr="data-full=@{'/uploads/' + ${photo.fileName}},data-title=${photo.originalName}"
                    >
                        <div class="thumb">
                            <img
                                th:src="@{'/uploads/' + ${photo.fileName}}"
                                th:alt="${photo.originalName}"
                                onerror="
                                    this.src = '/images/placeholder.jpg'
                                "
                            />
                            <div class="overlay">
                                <div>
                                    <div
                                        class="muted small"
                                        th:if="${photo.camera}"
                                        th:text="${photo.camera}"
                                    ></div>
                                    <div
                                        class="muted small"
                                        th:if="${photo.dateTaken}"
                                        th:text="${photo.dateTaken}"
                                    ></div>
                                </div>
                                <form
                                    th:action="@{/photo/{id}/delete(id=${photo.id})}"
                                    method="post"
                                    onsubmit="
                                        return confirm(
                                            'Delete this photo?',
                                        );
                                    "
                                >
                                    <input
                                        type="hidden"
                                        th:name="${_csrf.parameterName}"
                                        th:value="${_csrf.token}"
                                    />
                                    <input
                                        type="hidden"
                                        name="_method"
                                        value="DELETE"
                                    />
                                    <button
                                        type="submit"
                                        class="ghost-btn"
                                    >
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="tile-meta">
                            <div
                                class="strong small"
                                th:text="${photo.originalName}"
                            ></div>
                            <div
                                class="muted small"
                                th:if="${photo.imageWidth != null and photo.imageHeight != null}"
                                th:text="${photo.imageWidth} + '×' + ${photo.imageHeight}"
                            ></div>
                        </div>
                    </div>
                </div>

                <div
                    class="muted text-center"
                    th:if="${currentGallery != null and (photos == null or photos.size() == 0)}"
                >
                    No photos here yet. Upload some when you’re ready.
                </div>

                <article
                    class="card text-center muted"
                    th:if="${currentGallery == null}"
                >
                    Head back to your dashboard to choose a gallery.
                </article>
            </main>
        </div>

        <!-- Lightbox preview -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-inner">
                <div class="lightbox-bar">
                    <div class="lightbox-title" id="lightboxTitle"></div>
                    <button class="lightbox-close" id="lightboxClose">
                        Close
                    </button>
                </div>
                <img class="lightbox-img" id="lightboxImg" alt="" />
            </div>
        </div>

        <script>
            (function () {
                const grid = document.getElementById('masonryGrid');
                const box = document.getElementById('lightbox');
                const img = document.getElementById('lightboxImg');
                const title = document.getElementById('lightboxTitle');
                const closeBtn = document.getElementById('lightboxClose');
                if (!grid || !box || !img) return;

                function openLightbox(src, caption) {
                    img.src = src;
                    title.textContent = caption || '';
                    box.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
                function closeLightbox() {
                    box.classList.remove('open');
                    img.src = '';
                    document.body.style.overflow = '';
                }

                grid.addEventListener('click', (e) => {
                    const tile = e.target.closest('.tile');
                    if (!tile) return;
                    const full = tile.getAttribute('data-full');
                    if (!full) return;
                    openLightbox(full, tile.getAttribute('data-title'));
                });

                closeBtn && closeBtn.addEventListener('click', closeLightbox);
                box.addEventListener('click', (e) => {
                    if (e.target === box) closeLightbox();
                });
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeLightbox();
                });
            })();
        </script>

        <script>
            (function () {
                const form = document.getElementById('bulkUploadForm');
                const fileInput = document.getElementById('fileInput');
                const duplicateMode = document.getElementById('duplicateMode');
                const statusEl = document.getElementById('uploadStatus');
                if (!form || !fileInput) return;

                const csrfToken =
                    document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
                    null;
                const csrfHeader =
                    document
                        .querySelector('meta[name="_csrf_header"]')
                        ?.getAttribute('content') || 'X-CSRF-TOKEN';

                function setStatus(text) {
                    if (!statusEl) return;
                    statusEl.textContent = text || '';
                }

                async function readError(response) {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        try {
                            const json = await response.json();
                            return json?.message || JSON.stringify(json);
                        } catch {
                            return 'Request failed';
                        }
                    }
                    try {
                        return await response.text();
                    } catch {
                        return 'Request failed';
                    }
                }

                form.addEventListener('submit', async (e) => {
                    const files = Array.from(fileInput.files || []);
                    if (files.length === 0) return;

                    // If we don't have CSRF info, fall back to normal form post.
                    if (!csrfToken) return;

                    e.preventDefault();
                    setStatus(`Uploading ${files.length} photo(s)…`);

                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.disabled = true;

                    const galleryId = form.querySelector('input[name="galleryId"]')?.value;
                    if (!galleryId) {
                        setStatus('Missing gallery id; refresh and try again.');
                        if (submitBtn) submitBtn.disabled = false;
                        return;
                    }

                    const mode = duplicateMode?.value || 'cancel';
                    let success = 0;
                    let skipped = 0;
                    let failed = 0;

                    for (let index = 0; index < files.length; index++) {
                        const file = files[index];
                        setStatus(
                            `Uploading ${index + 1}/${files.length}: ${file.name}…`
                        );

                        try {
                            const formData = new FormData();
                            formData.append('file', file);

                            const uploadResp = await fetch(
                                `/api/photos?onDuplicate=${encodeURIComponent(
                                    mode
                                )}&galleryId=${encodeURIComponent(galleryId)}`,
                                {
                                    method: 'POST',
                                    body: formData,
                                    credentials: 'same-origin',
                                    headers: {
                                        [csrfHeader]: csrfToken,
                                    },
                                }
                            );

                            if (!uploadResp.ok) {
                                const err = await readError(uploadResp);
                                if (
                                    uploadResp.status === 400 &&
                                    String(err).toLowerCase().includes('duplicate')
                                ) {
                                    skipped++;
                                    continue;
                                }
                                failed++;
                                continue;
                            }

                            const photo = await uploadResp.json();
                            const linkResp = await fetch(
                                `/api/galleries/${encodeURIComponent(
                                    galleryId
                                )}/photos/${encodeURIComponent(photo.id)}`,
                                {
                                    method: 'POST',
                                    credentials: 'same-origin',
                                    headers: {
                                        [csrfHeader]: csrfToken,
                                    },
                                }
                            );
                            if (!linkResp.ok) {
                                failed++;
                                continue;
                            }

                            success++;
                        } catch (err) {
                            failed++;
                        }
                    }

                    setStatus(
                        `Done. Uploaded ${success}, skipped ${skipped}, failed ${failed}. Redirecting…`
                    );
                    const redirectUrl =
                        /*[[${currentGallery != null and currentGallery.slug != null ? '/' + currentGallery.slug : '/gallery/' + currentGallery.id}]]*/ '/';
                    window.location.assign(redirectUrl);
                });
            })();
        </script>
    </body>
</html>
