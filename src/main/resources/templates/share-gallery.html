<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title
            th:text="${currentGallery != null ? currentGallery.title + ' — Shared gallery' : 'Shared gallery'}"
        ></title>
        <link rel="stylesheet" th:href="@{/css/style.css}" />
    </head>
    <body class="page">
        <div class="bg-mesh"></div>
        <div class="shell app-shell">
            <header class="app-nav">
                <a class="brand" th:href="@{/}" aria-label="Deliverable home">
                    <img
                        class="brand-logo brand-logo-mobile"
                        th:src="@{/img/logo.png}"
                        alt="Deliverable"
                        decoding="async"
                    />
                    <img
                        class="brand-logo brand-logo-desktop"
                        th:src="@{/img/logo-full.png}"
                        alt="Deliverable"
                        decoding="async"
                    />
                </a>
                <nav class="nav-actions" aria-label="Primary">
                    <a
                        class="btn secondary"
                        th:if="${currentAlbum != null}"
                        th:href="@{/share/{tokenId}(tokenId=${shareTokenId})}"
                    >
                        Back to album
                    </a>
                    <a class="btn secondary" th:href="@{/}">
                        Home
                    </a>
                    <a class="btn primary" th:href="@{/login}">
                        Sign in
                    </a>
                </nav>
            </header>

            <main class="app-main">
                <div class="workbench">
                    <section class="column main">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <p class="eyebrow">Shared gallery</p>
                                <h2
                                    th:text="${currentGallery != null ? currentGallery.title : 'Gallery'}"
                                ></h2>
                                <p
                                    class="muted small"
                                    th:if="${currentAlbum != null}"
                                >
                                    <a
                                        class="pill ghost"
                                        th:href="@{/share/{tokenId}(tokenId=${shareTokenId})}"
                                    >
                                        Back to album
                                    </a>
                                </p>
                            </div>
                            <span class="pill ghost">Read-only</span>
                        </div>
                    </article>

                    <div
                        class="masonry"
                        id="masonryGrid"
                        th:if="${currentGallery != null}"
                        th:attr="data-token-id=${shareTokenId}"
                    >
                        <div
                            class="tile"
                            th:each="photo : ${photos}"
                            th:attr="data-full=@{/share/{tokenId}/photo/{photoId}(tokenId=${shareTokenId}, photoId=${photo.id})},data-title=${photo.originalName},data-photo-id=${photo.id}"
                        >
                            <div class="thumb">
                                <img
                                    th:src="@{/share/{tokenId}/photo/{photoId}(tokenId=${shareTokenId}, photoId=${photo.id})}"
                                    th:alt="${photo.originalName}"
                                    onload="
                                        this.classList.add('loaded');
                                        if (this.closest) {
                                            const thumb = this.closest('.thumb');
                                            if (thumb) thumb.classList.add('loaded');
                                        }
                                    "
                                    onerror="
                                        this.style.display='none';
                                        this.classList.add('loaded');
                                        if (this.closest) {
                                            const thumb = this.closest('.thumb');
                                            if (thumb) thumb.classList.add('loaded');
                                        }
                                    "
                                />
                            <div class="overlay">
                                    <div>
                                        <a
                                            class="icon-btn"
                                            th:href="@{/share/{tokenId}/photo/{photoId}/download(tokenId=${shareTokenId}, photoId=${photo.id}, variant='original')}"
                                            download
                                            aria-label="Download original"
                                            title="Download original"
                                        >
                                            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                                <path
                                                    d="M12 3v10"
                                                    stroke="currentColor"
                                                    stroke-width="1.8"
                                                    stroke-linecap="round"
                                                />
                                                <path
                                                    d="M8 11l4 4 4-4"
                                                    stroke="currentColor"
                                                    stroke-width="1.8"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                />
                                                <path
                                                    d="M4 20h16"
                                                    stroke="currentColor"
                                                    stroke-width="1.8"
                                                    stroke-linecap="round"
                                                />
                                            </svg>
                                        </a>
                                    </div>
                                    <span class="pill ghost">View</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <article class="card text-center muted" th:if="${photos == null or photos.isEmpty()}">
                        No photos yet.
                    </article>
                    </section>
                </div>
            </main>
        </div>

        <div class="lightbox" id="lightbox">
            <div class="lightbox-inner">
                <div class="lightbox-bar">
                    <div class="lightbox-title" id="lightboxTitle"></div>
                    <button class="lightbox-close" id="lightboxClose">✕</button>
                </div>
                <img class="lightbox-img" id="lightboxImg" alt="" />
            </div>
        </div>

        <script>
            (function () {
                const imgs = document.querySelectorAll('.thumb img');
                imgs.forEach((img) => {
                    const markLoaded = () => {
                        img.classList.add('loaded');
                        const thumb = img.closest('.thumb');
                        if (thumb) thumb.classList.add('loaded');
                    };
                    img.addEventListener('load', markLoaded, { once: true });
                    if (img.complete && img.naturalWidth > 0) {
                        markLoaded();
                    }
                });
            })();
        </script>

        <script>
            (function () {
                const grid = document.getElementById('masonryGrid');
                const box = document.getElementById('lightbox');
                const img = document.getElementById('lightboxImg');
                const title = document.getElementById('lightboxTitle');
                const closeBtn = document.getElementById('lightboxClose');
                if (!grid || !box || !img) return;

                const tokenId = grid.getAttribute('data-token-id');

                function openLightbox(src, caption, photoId) {
                    img.src = src;
                    title.textContent = caption || '';
                    box.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
                function closeLightbox() {
                    box.classList.remove('open');
                    img.src = '';
                    document.body.style.overflow = '';
                }

                grid.addEventListener('click', (e) => {
                    if (e.target.closest('a,button,form,input')) return;
                    const tile = e.target.closest('.tile');
                    if (!tile) return;
                    const full = tile.getAttribute('data-full');
                    if (!full) return;
                    const pid = tile.getAttribute('data-photo-id');
                    openLightbox(full, tile.getAttribute('data-title'), pid);
                });

                closeBtn && closeBtn.addEventListener('click', closeLightbox);
                box.addEventListener('click', (e) => {
                    if (e.target === box) closeLightbox();
                });
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeLightbox();
                });
            })();
        </script>
    </body>
</html>
